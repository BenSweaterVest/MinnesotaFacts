<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M.I.N.N.E.S.O.T.A. - Minnesota Institute for Not Necessarily Evidence-Supported Observations, Theories, and Anecdotes</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Linux Libertine', 'Georgia', 'Times', serif;
            line-height: 1.6;
            background: #f6f6f6;
        }

        .header {
            background: #a7d8f0;
            border-bottom: 3px solid #a2a9b1;
            padding: 0.5em 0;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }

        .logo {
            font-size: 1.8em;
            font-weight: bold;
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }

        .logo-subtitle {
            font-size: 0.4em;
            font-weight: normal;
            color: #333;
            display: block;
            margin-top: 2px;
            font-style: italic;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            gap: 20px;
            padding: 20px;
        }

        .sidebar {
            width: 250px;
            background: white;
            border: 1px solid #a2a9b1;
            padding: 15px;
            height: fit-content;
            border-radius: 3px;
        }

        .sidebar h3 {
            background: #eaecf0;
            margin: -15px -15px 10px -15px;
            padding: 8px 15px;
            font-size: 0.95em;
            border-bottom: 1px solid #a2a9b1;
        }

        .sidebar ul {
            list-style: none;
        }

        .sidebar li {
            margin: 5px 0;
        }

        .sidebar a {
            color: #0645ad;
            text-decoration: none;
            display: block;
            padding: 2px 5px;
            border-radius: 2px;
            cursor: pointer;
        }

        .sidebar a:hover {
            background: #f8f9fa;
        }

        .sidebar a.active {
            background: #0645ad;
            color: white;
        }

        .article-list-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 3px;
            margin-bottom: 15px;
        }

        .article-list-container::-webkit-scrollbar {
            width: 8px;
        }

        .article-list-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .article-list-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .article-list-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        #article-list {
            padding: 5px;
        }

        .admin-link {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e0e0e0;
        }

        .admin-link a {
            font-size: 0.85em;
            color: #666;
            font-style: italic;
        }

        .content {
            flex: 1;
            background: white;
            border: 1px solid #a2a9b1;
            padding: 20px;
            border-radius: 3px;
        }

        .article-title {
            font-size: 2.2em;
            font-weight: normal;
            margin-bottom: 10px;
            border-bottom: 3px solid #a2a9b1;
            padding-bottom: 5px;
            position: relative;
        }

        .permalink {
            position: absolute;
            right: 0;
            bottom: 8px;
            font-size: 0.4em;
            color: #666;
            text-decoration: none;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .permalink:hover {
            opacity: 1;
            color: #0645ad;
        }

        .article-content h2 {
            font-size: 1.5em;
            margin: 20px 0 10px 0;
            border-bottom: 1px solid #a2a9b1;
            padding-bottom: 2px;
        }

        .article-content h3 {
            font-size: 1.2em;
            margin: 15px 0 8px 0;
        }

        .article-content p {
            margin-bottom: 15px;
            text-align: justify;
        }

        .infobox {
            float: right;
            width: 300px;
            margin: 0 0 15px 15px;
            border: 1px solid #a2a9b1;
            background: #f8f9fa;
            font-size: 0.9em;
        }

        .infobox-title {
            background: #ccccff;
            padding: 5px 10px;
            font-weight: bold;
            text-align: center;
        }

        .infobox-content {
            padding: 10px;
        }

        .infobox-row {
            display: flex;
            margin: 5px 0;
        }

        .infobox-label {
            font-weight: bold;
            width: 100px;
            flex-shrink: 0;
        }

        .search-container {
            margin: 20px 0;
        }

        .search-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #a2a9b1;
            border-radius: 2px;
            font-size: 14px;
        }

        .btn {
            background: #0645ad;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn:hover {
            background: #0b0080;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #54595d;
        }

        .btn-secondary:hover {
            background: #495057;
        }

        .edit-form {
            display: none;
        }

        .edit-form textarea {
            width: 100%;
            height: 400px;
            padding: 10px;
            border: 1px solid #a2a9b1;
            border-radius: 3px;
            font-family: monospace;
            font-size: 14px;
        }

        .form-group {
            margin: 15px 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #a2a9b1;
            border-radius: 2px;
        }

        .admin-controls {
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border: 1px solid #a2a9b1;
            border-radius: 3px;
        }

        .hidden {
            display: none !important;
        }

        .error {
            color: #d33;
            background: #fee;
            padding: 10px;
            border: 1px solid #fcc;
            border-radius: 3px;
            margin: 10px 0;
        }

        .success {
            color: #396;
            background: #efe;
            padding: 10px;
            border: 1px solid #cfc;
            border-radius: 3px;
            margin: 10px 0;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                padding: 10px;
            }
            
            .sidebar {
                width: 100%;
            }
            
            .infobox {
                float: none;
                width: 100%;
                margin: 15px 0;
            }

            .article-list-container {
                max-height: 200px;
            }

            .logo {
                font-size: 1.4em;
            }

            .logo-subtitle {
                font-size: 0.35em;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="#" class="logo" onclick="showHome()">
                M.I.N.N.E.S.O.T.A.
                <span class="logo-subtitle">Minnesota Institute for Not Necessarily Evidence-Supported Observations, Theories, and Anecdotes</span>
            </a>
        </div>
    </header>

    <div class="main-container">
        <aside class="sidebar">
            <h3>Articles</h3>
            <div class="article-list-container">
                <ul id="article-list">
                    <li><a href="#" onclick="showHome()">Main Page</a></li>
                    <li><a href="#giant-paul-bunyan" onclick="showArticle('giant-paul-bunyan')">The Giant Paul Bunyan Incident of 1987</a></li>
                    <li><a href="#minnesota-goodbye" onclick="showArticle('minnesota-goodbye')">The Minnesota Goodbye</a></li>
                    <li><a href="#hotdish-wars" onclick="showArticle('hotdish-wars')">The Great Hotdish Wars</a></li>
                    <li><a href="#lake-monster" onclick="showArticle('lake-monster')">Lake Minnetonka Monster</a></li>
                </ul>
            </div>
            
            <h3>Search</h3>
            <div class="search-container">
                <input type="text" class="search-input" placeholder="Search M.I.N.N.E.S.O.T.A..." id="search-input" onkeyup="handleSearch(event)">
                <button onclick="performSearch()" class="btn" style="margin-top: 5px; width: 100%; font-size: 12px; padding: 4px 8px;">Search</button>
            </div>

            <div class="admin-link">
                <a href="#admin" onclick="showArticle('admin')">Login</a>
            </div>

            <div id="admin-sidebar" class="hidden">
                <h3>Admin Tools</h3>
                <ul>
                    <li><a href="#" onclick="showNewArticleForm()">Create New Article</a></li>
                    <li><a href="#" onclick="showEditForm()">Edit Current Article</a></li>
                </ul>
            </div>
        </aside>

        <main class="content">
            <div id="article-content" style="display: block;">
                <h1 class="article-title">
                    Welcome to M.I.N.N.E.S.O.T.A.
                    <a href="#home" class="permalink">¶</a>
                </h1>
                <div class="article-content">
                    <p><strong>M.I.N.N.E.S.O.T.A.</strong> (Minnesota Institute for Not Necessarily Evidence-Supported Observations, Theories, and Anecdotes) is the premier research institution dedicated to documenting Minnesota's most important cultural phenomena, historical events, and legendary figures—regardless of their verifiability.</p>
                    
                    <h2>Our Mission</h2>
                    <p>The Institute is committed to preserving and sharing Minnesota's rich heritage of questionable facts, dubious claims, and thoroughly entertaining stories that may or may not have actually happened. We believe that truth is less important than a good story, especially when that story involves hotdish.</p>
                    
                    <h2>Featured Research</h2>
                    <p>Explore our comprehensive archives documenting crucial Minnesota phenomena, from the legendary <a href="#" onclick="showArticle('giant-paul-bunyan')">Giant Paul Bunyan incident of 1987</a> to the ongoing <a href="#" onclick="showArticle('hotdish-wars')">Great Hotdish Wars</a> that continue to shape the state's culinary and political landscape.</p>
                    
                    <p>Our researchers have meticulously documented unique Minnesota customs like <a href="#" onclick="showArticle('minnesota-goodbye')">The Minnesota Goodbye</a>, a complex social ritual that can extend social gatherings by several hours, and investigated sightings of the elusive <a href="#" onclick="showArticle('lake-monster')">Lake Minnetonka Monster</a>, which demonstrates remarkable camera-avoidance abilities.</p>
                    
                    <h2>About Our Research Methods</h2>
                    <p>The Institute employs rigorous* research methodologies to ensure the authenticity** of all documented phenomena. Our findings have been thoroughly peer-reviewed*** by leading experts**** in the field of Minnesota studies.</p>
                    
                    <h2>Institute Standards</h2>
                    <p style="font-size: 0.9em; color: #666; background: #f9f9f9; padding: 15px; border-left: 4px solid #a7d8f0;">
                        <strong>Research Quality Assurance:</strong><br>
                        *Rigorous: We ask at least two people if they've heard the story<br>
                        **Authenticity verified through the "Minnesota Nice Test": Does it sound like something a Minnesotan would do?<br>
                        ***Peer review conducted at coffee shops, church basements, and ice fishing houses<br>
                        ****Experts: Individuals who have survived more than three Minnesota winters and can pronounce "Wayzata" correctly
                    </p>
                    
                    <h2>Contact the Institute</h2>
                    <p>For research inquiries, story submissions, or hotdish-related disputes, please contact us through the traditional Minnesota method of bringing up your concerns during casual conversation at the grocery store checkout line.</p>
                </div>
            </div>

            <div id="edit-content" class="edit-form">
                <h1 class="article-title">Edit Article</h1>
                <form onsubmit="saveArticle(event)">
                    <div class="form-group">
                        <label for="edit-title">Article Title:</label>
                        <input type="text" id="edit-title" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-slug">URL Slug:</label>
                        <input type="text" id="edit-slug" required placeholder="lowercase-with-hyphens">
                    </div>
                    <div class="form-group">
                        <label for="edit-content-area">Content (HTML allowed):</label>
                        <textarea id="edit-content-area" required placeholder="Enter your article content here..."></textarea>
                    </div>
                    <div class="admin-controls">
                        <button type="submit" class="btn">Save Article</button>
                        <button type="button" class="btn btn-secondary" onclick="cancelEdit()">Cancel</button>
                        <button type="button" class="btn btn-secondary" onclick="deleteCurrentArticle()" style="background: #dc3545;">Delete Article</button>
                    </div>
                </form>
            </div>
            
            <div id="github-content" class="edit-form">
                <h1 class="article-title">GitHub Configuration</h1>
                <div class="article-content">
                    <p><strong>Authentication Status:</strong> <span id="auth-status">Not authenticated</span></p>
                    <p>GitHub token will be retrieved automatically upon successful authentication.</p>
                </div>
                <div class="form-group">
                    <label for="gh-owner">Repository Owner:</label>
                    <input type="text" id="gh-owner" placeholder="GitHub username or organization">
                </div>
                <div class="form-group">
                    <label for="gh-repo">Repository Name:</label>
                    <input type="text" id="gh-repo" placeholder="Repository name">
                </div>
                <div class="form-group">
                    <label for="gh-branch">Branch:</label>
                    <input type="text" id="gh-branch" placeholder="Branch name (e.g., main)" value="main">
                </div>
                <div class="form-group">
                    <label for="gh-path">File Path:</label>
                    <input type="text" id="gh-path" placeholder="Path to HTML file (e.g., index.html)" value="index.html">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        This entire wiki will be saved as a single HTML file
                    </small>
                </div>
                <div class="admin-controls">
                    <button onclick="saveGitHubConfig()" class="btn">Save Configuration</button>
                    <button onclick="testGitHubConnection()" class="btn btn-secondary">Test Connection</button>
                    <button onclick="saveWikiToGitHub()" class="btn">Save Wiki to GitHub</button>
                    <button onclick="loadWikiFromGitHub()" class="btn btn-secondary">Load from GitHub</button>
                    <button type="button" class="btn btn-secondary" onclick="showArticle('admin')">Back to Admin</button>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Configuration - Update this to match your Cloudflare Pages domain
        const API_BASE_URL = '/functions/api'; // For same domain deployment
        // Alternative: const API_BASE_URL = 'https://your-site.pages.dev/functions/api'; // For different domain
        
        // Test function - you can run this in the browser console
        window.testAuthEndpoint = async function() {
            console.log('Testing auth endpoint...');
            
            // Test GET request first
            try {
                const getResponse = await fetch(`${API_BASE_URL}/auth`);
                console.log('GET Response status:', getResponse.status);
                const getData = await getResponse.json();
                console.log('GET Response data:', getData);
            } catch (e) {
                console.error('GET test failed:', e);
            }
            
            // Test POST request
            try {
                const postResponse = await fetch(`${API_BASE_URL}/auth`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: 'test' })
                });
                console.log('POST Response status:', postResponse.status);
                const postData = await postResponse.json();
                console.log('POST Response data:', postData);
            } catch (e) {
                console.error('POST test failed:', e);
            }
        };
        
        // State management
        let isLoggedIn = false;
        let currentArticle = 'home';
        let githubToken = null;
        
        // GitHub configuration - will be saved to localStorage
        let githubConfig = {
            owner: 'BenSweaterVest',
            repo: 'MinnesotaFacts',
            branch: 'main',
            path: 'index.html'
        };
        
        // Sample articles data
        let articles = {
            "admin": {
                "title": "Admin Panel",
                "content": `<div id="admin-login-section">
                    <p>This is the administrative control panel for M.I.N.N.E.S.O.T.A. Please log in to access editing functions.</p>
                    
                    <div class="form-group">
                        <label for="admin-login-password">Admin Password:</label>
                        <input type="password" id="admin-login-password" placeholder="Enter admin password" onkeyup="handleAdminLoginKeypress(event)">
                    </div>
                    <div class="admin-controls">
                        <button onclick="handleAdminLogin()" class="btn" id="login-btn">Login</button>
                    </div>
                </div>
                
                <div id="admin-dashboard" class="hidden">
                    <p><strong>Welcome, Administrator!</strong> You now have access to all Institute editing functions.</p>
                    
                    <h2>Quick Actions</h2>
                    <div class="admin-controls">
                        <button onclick="showNewArticleForm()" class="btn">Create New Article</button>
                        <button onclick="showEditForm()" class="btn btn-secondary">Edit Current Article</button>
                        <button onclick="showGitHubConfig()" class="btn btn-secondary">GitHub Settings</button>
                        <button onclick="handleAdminLogout()" class="btn" style="background: #dc3545;">Logout</button>
                    </div>
                    
                    <h2>Article Management</h2>
                    <div id="article-management">
                        <p>Current research documents in the Institute archives:</p>
                        <ul id="admin-article-list"></ul>
                    </div>
                </div>`
            },
            "home": {
                "title": "Welcome to M.I.N.N.E.S.O.T.A.",
                "content": `<p><strong>M.I.N.N.E.S.O.T.A.</strong> (Minnesota Institute for Not Necessarily Evidence-Supported Observations, Theories, and Anecdotes) is the premier research institution dedicated to documenting Minnesota's most important cultural phenomena, historical events, and legendary figures—regardless of their verifiability.</p>
                
                <h2>Our Mission</h2>
                <p>The Institute is committed to preserving and sharing Minnesota's rich heritage of questionable facts, dubious claims, and thoroughly entertaining stories that may or may not have actually happened. We believe that truth is less important than a good story, especially when that story involves hotdish.</p>
                
                <h2>Featured Research</h2>
                <p>Explore our comprehensive archives documenting crucial Minnesota phenomena, from the legendary <a href="#" onclick="showArticle('giant-paul-bunyan')">Giant Paul Bunyan incident of 1987</a> to the ongoing <a href="#" onclick="showArticle('hotdish-wars')">Great Hotdish Wars</a> that continue to shape the state's culinary and political landscape.</p>
                
                <p>Our researchers have meticulously documented unique Minnesota customs like <a href="#" onclick="showArticle('minnesota-goodbye')">The Minnesota Goodbye</a>, a complex social ritual that can extend social gatherings by several hours, and investigated sightings of the elusive <a href="#" onclick="showArticle('lake-monster')">Lake Minnetonka Monster</a>, which demonstrates remarkable camera-avoidance abilities.</p>
                
                <h2>About Our Research Methods</h2>
                <p>The Institute employs rigorous* research methodologies to ensure the authenticity** of all documented phenomena. Our findings have been thoroughly peer-reviewed*** by leading experts**** in the field of Minnesota studies.</p>
                
                <h2>Institute Standards</h2>
                <p style="font-size: 0.9em; color: #666; background: #f9f9f9; padding: 15px; border-left: 4px solid #a7d8f0;">
                    <strong>Research Quality Assurance:</strong><br>
                    *Rigorous: We ask at least two people if they've heard the story<br>
                    **Authenticity verified through the "Minnesota Nice Test": Does it sound like something a Minnesotan would do?<br>
                    ***Peer review conducted at coffee shops, church basements, and ice fishing houses<br>
                    ****Experts: Individuals who have survived more than three Minnesota winters and can pronounce "Wayzata" correctly
                </p>
                
                <h2>Contact the Institute</h2>
                <p>For research inquiries, story submissions, or hotdish-related disputes, please contact us through the traditional Minnesota method of bringing up your concerns during casual conversation at the grocery store checkout line.</p>`
            },
            "giant-paul-bunyan": {
                "title": "The Giant Paul Bunyan Incident of 1987",
                "content": `<div class="infobox">
                    <div class="infobox-title">Paul Bunyan Incident</div>
                    <div class="infobox-content">
                        <div class="infobox-row">
                            <div class="infobox-label">Date:</div>
                            <div>July 4, 1987</div>
                        </div>
                        <div class="infobox-row">
                            <div class="infobox-label">Location:</div>
                            <div>Bemidji, Minnesota</div>
                        </div>
                        <div class="infobox-row">
                            <div class="infobox-label">Casualties:</div>
                            <div>12 lawn chairs, 1 hot dog stand</div>
                        </div>
                        <div class="infobox-row">
                            <div class="infobox-label">Status:</div>
                            <div>Covered up by Big Tourism</div>
                        </div>
                    </div>
                </div>
                
                <p>The <strong>Giant Paul Bunyan Incident of 1987</strong> remains the most controversial event in Minnesota tourism history, despite efforts by the Minnesota Tourism Board to suppress all documentation of the occurrence.</p>
                
                <h2>Background</h2>
                <p>The 18-foot Paul Bunyan statue in Bemidji had been behaving normally for decades, standing stoically next to Babe the Blue Ox and posing for countless tourist photographs. However, witnesses report that on the morning of July 4th, 1987, the statue began exhibiting what can only be described as "aggressive tourist interaction patterns."</p>
                
                <h2>The Incident</h2>
                <p>According to eyewitness testimony collected by M.I.N.N.E.S.O.T.A. researchers, the statue first showed signs of animation at approximately 10:30 AM during the annual Fourth of July picnic. Mrs. Ethel Nordstrom of Bagley reported that Paul's axe began "twitching menacingly" whenever tourists attempted to pose for photos without purchasing souvenirs from the adjacent gift shop.</p>
                
                <p>The situation escalated rapidly when the Bunyan statue reportedly stood up, stretched (causing several car alarms to activate from the sonic boom), and began actively herding tourists toward the gift shop while muttering something about "authentic Minnesota experiences" and "supporting local businesses."</p>
                
                <h2>See Also</h2>
                <p>• <a href="#" onclick="showArticle('minnesota-goodbye')">The Minnesota Goodbye</a><br>
                • <a href="#" onclick="showArticle('lake-monster')">Lake Minnetonka Monster</a></p>`
            },
            "minnesota-goodbye": {
                "title": "The Minnesota Goodbye",
                "content": `<p>The <strong>Minnesota Goodbye</strong> is a complex social ritual practiced throughout the state of Minnesota, characterized by its ability to extend any social gathering by a minimum of 45 minutes to several hours beyond the initial departure announcement.</p>
                
                <h2>Definition and Characteristics</h2>
                <p>Unlike the abrupt departures common in other regions, the Minnesota Goodbye follows a strict protocol that ensures no one's feelings are hurt and that all participants have multiple opportunities to share additional anecdotes, weather observations, and casserole recipes.</p>
                
                <h2>The Seven Stages</h2>
                
                <h3>Stage 1: The Initial Announcement (5-15 minutes)</h3>
                <p>The departing party announces their intention to leave, usually prefaced with observations about the time, weather, or upcoming obligations.</p>
                
                <h3>Stage 2: The Coat Gathering Ceremony (10-20 minutes)</h3>
                <p>Participants begin the ritual collection of coats, purses, and casserole dishes.</p>
                
                <h2>See Also</h2>
                <p>• <a href="#" onclick="showArticle('hotdish-wars')">The Great Hotdish Wars</a></p>`
            },
            "hotdish-wars": {
                "title": "The Great Hotdish Wars",
                "content": `<p>The <strong>Great Hotdish Wars</strong> refer to the ongoing series of culinary conflicts that have shaped Minnesota's social and political landscape since the early 1950s.</p>
                
                <h2>Historical Background</h2>
                <p>The conflict began innocuously in 1953 when Marge Olson of Hibbing claimed at the annual Lutheran church potluck that her tater tot hotdish was "the best in the Range."</p>
                
                <h2>See Also</h2>
                <p>• <a href="#" onclick="showArticle('minnesota-goodbye')">The Minnesota Goodbye</a><br>
                • <a href="#" onclick="showArticle('lake-monster')">Lake Minnetonka Monster</a></p>`
            },
            "lake-monster": {
                "title": "Lake Minnetonka Monster",
                "content": `<div class="infobox">
                    <div class="infobox-title">Lake Minnetonka Monster</div>
                    <div class="infobox-content">
                        <div class="infobox-row">
                            <div class="infobox-label">First Sighting:</div>
                            <div>June 15, 1923</div>
                        </div>
                        <div class="infobox-row">
                            <div class="infobox-label">Status:</div>
                            <div>Politely elusive</div>
                        </div>
                    </div>
                </div>
                
                <p>The <strong>Lake Minnetonka Monster</strong>, affectionately known as "Tonka" by local residents, is Minnesota's most courteous cryptid.</p>
                
                <h2>Discovery and Early Sightings</h2>
                <p>The creature was first spotted on June 15, 1923, by Margaret Lindström while she was hanging laundry near the shoreline.</p>
                
                <h2>See Also</h2>
                <p>• <a href="#" onclick="showArticle('giant-paul-bunyan')">Giant Paul Bunyan Incident</a></p>`
            }
        };
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            loadGitHubConfig();
            showHome();
            updateSidebar();
        });
        
        // Authentication functions
        async function authenticateWithAPI(password) {
            try {
                console.log('Attempting authentication with API:', `${API_BASE_URL}/auth`);
                console.log('Password being sent:', password);
                
                const response = await fetch(`${API_BASE_URL}/auth`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ password: password })
                });
                
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                const data = await response.json();
                console.log('Response data:', data);
                
                if (data.success) {
                    githubToken = data.githubToken;
                    return true;
                } else {
                    showMessage(`Authentication failed: ${data.message}`, 'error');
                    return false;
                }
            } catch (error) {
                console.error('Authentication error:', error);
                showMessage(`Authentication service error: ${error.message}. Check console for details.`, 'error');
                return false;
            }
        }
        
        async function handleAdminLogin() {
            const password = document.getElementById('admin-login-password').value;
            const loginBtn = document.getElementById('login-btn');
            
            if (!password) {
                showMessage('Please enter a password.', 'error');
                return;
            }
            
            // Show loading state
            loginBtn.disabled = true;
            loginBtn.textContent = 'Authenticating...';
            
            const success = await authenticateWithAPI(password);
            
            if (success) {
                isLoggedIn = true;
                updateAdminContent();
                updateAuthStatus();
                showMessage('Successfully logged in as administrator.', 'success');
            } else {
                showMessage('Invalid password. Access denied.', 'error');
            }
            
            // Reset button state
            loginBtn.disabled = false;
            loginBtn.textContent = 'Login';
        }
        
        function handleAdminLoginKeypress(event) {
            if (event.key === 'Enter') {
                handleAdminLogin();
            }
        }
        
        function handleAdminLogout() {
            isLoggedIn = false;
            githubToken = null;
            updateAdminContent();
            updateAuthStatus();
            showMessage('Successfully logged out.', 'success');
        }
        
        function updateAuthStatus() {
            const authStatus = document.getElementById('auth-status');
            if (authStatus) {
                authStatus.textContent = isLoggedIn ? 'Authenticated with GitHub token' : 'Not authenticated';
                authStatus.style.color = isLoggedIn ? '#396' : '#d33';
            }
        }
        
        // Navigation functions
        function showHome() {
            showArticle('home');
        }
        
        function showArticle(articleId) {
            // Hide all content sections
            document.getElementById('article-content').style.display = 'block';
            document.getElementById('edit-content').style.display = 'none';
            document.getElementById('github-content').style.display = 'none';
            
            // Update current article
            currentArticle = articleId;
            
            // Load article content
            if (articles[articleId]) {
                const article = articles[articleId];
                document.getElementById('article-content').innerHTML = `
                    <h1 class="article-title">
                        ${article.title}
                        <a href="#${articleId}" class="permalink">¶</a>
                    </h1>
                    <div class="article-content">
                        ${article.content}
                    </div>
                `;
                
                // Update active link in sidebar
                updateActiveLink(articleId);
                
                // Special handling for admin page
                if (articleId === 'admin') {
                    updateAdminContent();
                }
            } else {
                document.getElementById('article-content').innerHTML = `
                    <h1 class="article-title">Article Not Found</h1>
                    <p>The requested article could not be found in the M.I.N.N.E.S.O.T.A. archives.</p>
                    <p><a href="#" onclick="showHome()">Return to Main Page</a></p>
                `;
            }
        }
        
        function updateActiveLink(articleId) {
            // Remove active class from all links
            const links = document.querySelectorAll('.sidebar a');
            links.forEach(link => link.classList.remove('active'));
            
            // Add active class to current link
            const currentLink = document.querySelector(`a[onclick*="${articleId}"]`);
            if (currentLink) {
                currentLink.classList.add('active');
            }
        }
        
        function updateSidebar() {
            const articleList = document.getElementById('article-list');
            articleList.innerHTML = '';
            
            // Add main page link
            const mainItem = document.createElement('li');
            mainItem.innerHTML = '<a href="#" onclick="showHome()">Main Page</a>';
            articleList.appendChild(mainItem);
            
            // Add other articles
            Object.keys(articles).forEach(key => {
                if (key !== 'home' && key !== 'admin') {
                    const item = document.createElement('li');
                    item.innerHTML = `<a href="#${key}" onclick="showArticle('${key}')">${articles[key].title}</a>`;
                    articleList.appendChild(item);
                }
            });
        }
        
        function updateAdminContent() {
            if (isLoggedIn) {
                document.getElementById('admin-login-section').classList.add('hidden');
                document.getElementById('admin-dashboard').classList.remove('hidden');
                document.getElementById('admin-sidebar').classList.remove('hidden');
                updateAdminArticleList();
            } else {
                document.getElementById('admin-login-section').classList.remove('hidden');
                document.getElementById('admin-dashboard').classList.add('hidden');
                document.getElementById('admin-sidebar').classList.add('hidden');
            }
        }
        
        function updateAdminArticleList() {
            const list = document.getElementById('admin-article-list');
            if (list) {
                list.innerHTML = '';
                Object.keys(articles).forEach(key => {
                    if (key !== 'admin') {
                        const item = document.createElement('li');
                        item.innerHTML = `${articles[key].title} 
                            <button onclick="editArticle('${key}')" class="btn" style="font-size: 10px; padding: 2px 6px; margin-left: 10px;">Edit</button>
                            <button onclick="deleteArticle('${key}')" class="btn" style="font-size: 10px; padding: 2px 6px; margin-left: 5px; background: #dc3545;">Delete</button>`;
                        list.appendChild(item);
                    }
                });
            }
        }
        
        // Article editing functions
        function showNewArticleForm() {
            if (!isLoggedIn) {
                showMessage('Please log in to access editing functions.', 'error');
                return;
            }
            
            document.getElementById('article-content').style.display = 'none';
            document.getElementById('edit-content').style.display = 'block';
            document.getElementById('github-content').style.display = 'none';
            
            // Clear form
            document.getElementById('edit-title').value = '';
            document.getElementById('edit-slug').value = '';
            document.getElementById('edit-content-area').value = '';
        }
        
        function showEditForm() {
            if (!isLoggedIn) {
                showMessage('Please log in to access editing functions.', 'error');
                return;
            }
            
            if (currentArticle === 'admin') {
                showMessage('The admin panel cannot be edited.', 'error');
                return;
            }
            
            const article = articles[currentArticle];
            if (!article) {
                showMessage('No article selected for editing.', 'error');
                return;
            }
            
            document.getElementById('article-content').style.display = 'none';
            document.getElementById('edit-content').style.display = 'block';
            document.getElementById('github-content').style.display = 'none';
            
            document.getElementById('edit-title').value = article.title;
            document.getElementById('edit-slug').value = currentArticle;
            document.getElementById('edit-content-area').value = article.content;
        }
        
        function editArticle(articleId) {
            currentArticle = articleId;
            showEditForm();
        }
        
        function deleteArticle(articleId) {
            if (!confirm(`Are you sure you want to delete "${articles[articleId].title}"?`)) {
                return;
            }
            
            delete articles[articleId];
            updateSidebar();
            updateAdminArticleList();
            showMessage('Article deleted successfully.', 'success');
            
            if (currentArticle === articleId) {
                showHome();
            }
        }
        
        function saveArticle(event) {
            event.preventDefault();
            
            const title = document.getElementById('edit-title').value;
            const slug = document.getElementById('edit-slug').value;
            const content = document.getElementById('edit-content-area').value;
            
            if (!title || !slug || !content) {
                showMessage('Please fill in all fields.', 'error');
                return;
            }
            
            articles[slug] = {
                title: title,
                content: content
            };
            
            updateSidebar();
            showArticle(slug);
            showMessage('Article saved successfully.', 'success');
        }
        
        function cancelEdit() {
            document.getElementById('article-content').style.display = 'block';
            document.getElementById('edit-content').style.display = 'none';
            document.getElementById('github-content').style.display = 'none';
        }
        
        function deleteCurrentArticle() {
            if (currentArticle === 'admin' || currentArticle === 'home') {
                showMessage('This article cannot be deleted.', 'error');
                return;
            }
            
            deleteArticle(currentArticle);
            showHome();
        }
        
        // Search functions
        function handleSearch(event) {
            if (event.key === 'Enter') {
                performSearch();
            }
        }
        
        function performSearch() {
            const query = document.getElementById('search-input').value.toLowerCase();
            if (!query) return;
            
            let results = [];
            Object.keys(articles).forEach(key => {
                const article = articles[key];
                if (article.title.toLowerCase().includes(query) || 
                    article.content.toLowerCase().includes(query)) {
                    results.push({key, title: article.title});
                }
            });
            
            if (results.length === 0) {
                showMessage('No articles found matching your search.', 'error');
            } else if (results.length === 1) {
                showArticle(results[0].key);
            } else {
                let resultHtml = '<h1 class="article-title">Search Results</h1><ul>';
                results.forEach(result => {
                    resultHtml += `<li><a href="#" onclick="showArticle('${result.key}')">${result.title}</a></li>`;
                });
                resultHtml += '</ul>';
                
                document.getElementById('article-content').innerHTML = resultHtml;
                document.getElementById('edit-content').style.display = 'none';
                document.getElementById('github-content').style.display = 'none';
                document.getElementById('article-content').style.display = 'block';
            }
        }
        
        // GitHub configuration functions
        function showGitHubConfig() {
            if (!isLoggedIn) {
                showMessage('Please log in to access GitHub settings.', 'error');
                return;
            }
            
            document.getElementById('article-content').style.display = 'none';
            document.getElementById('edit-content').style.display = 'none';
            document.getElementById('github-content').style.display = 'block';
            
            // Load current config
            document.getElementById('gh-owner').value = githubConfig.owner || '';
            document.getElementById('gh-repo').value = githubConfig.repo || '';
            document.getElementById('gh-branch').value = githubConfig.branch || 'main';
            document.getElementById('gh-path').value = githubConfig.path || 'index.html';
            
            updateAuthStatus();
        }
        
        function saveGitHubConfig() {
            githubConfig = {
                owner: document.getElementById('gh-owner').value,
                repo: document.getElementById('gh-repo').value,
                branch: document.getElementById('gh-branch').value,
                path: document.getElementById('gh-path').value
            };
            
            // Save to localStorage for persistence
            try {
                localStorage.setItem('minnesota-github-config', JSON.stringify(githubConfig));
            } catch (e) {
                // localStorage not available, config will reset on refresh
            }
            
            showMessage('GitHub configuration saved successfully.', 'success');
        }
        
        function loadGitHubConfig() {
            try {
                const saved = localStorage.getItem('minnesota-github-config');
                if (saved) {
                    const config = JSON.parse(saved);
                    githubConfig = { ...githubConfig, ...config };
                }
            } catch (e) {
                // localStorage not available or invalid data
            }
        }
        
        async function testGitHubConnection() {
            if (!githubToken) {
                showMessage('Please log in first to get GitHub authentication.', 'error');
                return;
            }
            
            if (!githubConfig.owner || !githubConfig.repo) {
                showMessage('Please fill in repository owner and name.', 'error');
                return;
            }
            
            try {
                const response = await fetch(`https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}`, {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    showMessage('GitHub connection successful!', 'success');
                } else {
                    showMessage(`GitHub connection failed: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                showMessage(`GitHub connection error: ${error.message}`, 'error');
            }
        }
        
        async function saveWikiToGitHub() {
            if (!githubToken) {
                showMessage('Please log in first to get GitHub authentication.', 'error');
                return;
            }
            
            if (!githubConfig.owner || !githubConfig.repo) {
                showMessage('Please configure GitHub settings first.', 'error');
                return;
            }
            
            try {
                showMessage('Saving to GitHub...', 'success');
                
                // Get current file SHA if it exists
                let sha = null;
                try {
                    const getResponse = await fetch(`https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${githubConfig.path}`, {
                        headers: {
                            'Authorization': `token ${githubToken}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (getResponse.ok) {
                        const data = await getResponse.json();
                        sha = data.sha;
                    }
                } catch (e) {
                    // File doesn't exist, that's okay
                }
                
                // Generate the complete HTML
                const completeHtml = generateCompleteHtml();
                const content = btoa(unescape(encodeURIComponent(completeHtml)));
                
                const updateData = {
                    message: `Update M.I.N.N.E.S.O.T.A. wiki - ${new Date().toISOString()}`,
                    content: content,
                    branch: githubConfig.branch
                };
                
                if (sha) {
                    updateData.sha = sha;
                }
                
                const response = await fetch(`https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${githubConfig.path}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showMessage(`Wiki successfully saved to GitHub! <a href="${result.content.html_url}" target="_blank">View on GitHub</a>`, 'success');
                } else {
                    const errorData = await response.json();
                    showMessage(`Failed to save to GitHub: ${errorData.message}`, 'error');
                }
            } catch (error) {
                showMessage(`Error saving to GitHub: ${error.message}`, 'error');
            }
        }
        
        async function loadWikiFromGitHub() {
            if (!githubToken) {
                showMessage('Please log in first to get GitHub authentication.', 'error');
                return;
            }
            
            if (!githubConfig.owner || !githubConfig.repo) {
                showMessage('Please configure GitHub settings first.', 'error');
                return;
            }
            
            try {
                const response = await fetch(`https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${githubConfig.path}`, {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const content = decodeURIComponent(escape(atob(data.content)));
                    
                    // This is a simplified approach - you might want to enhance this
                    // to properly parse the HTML and extract articles
                    showMessage('Wiki loaded from GitHub! Note: You may need to refresh to see all changes.', 'success');
                } else {
                    showMessage(`Failed to load from GitHub: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                showMessage(`Error loading from GitHub: ${error.message}`, 'error');
            }
        }
        
        function generateCompleteHtml() {
            // Create a copy of the current document
            const docClone = document.cloneNode(true);
            
            // Update the articles data in the script
            const scripts = docClone.querySelectorAll('script');
            scripts.forEach(script => {
                if (script.textContent.includes('let articles = {')) {
                    // Replace the articles object
                    const articlesJson = JSON.stringify(articles, null, 12);
                    script.textContent = script.textContent.replace(
                        /let articles = \{[\s\S]*?\};/,
                        `let articles = ${articlesJson};`
                    );
                }
            });
            
            return docClone.outerHTML;
        }
        
        function showMessage(message, type) {
            // Remove existing messages
            const existingMessages = document.querySelectorAll('.error, .success');
            existingMessages.forEach(msg => msg.remove());
            
            // Create new message
            const messageDiv = document.createElement('div');
            messageDiv.className = type;
            messageDiv.innerHTML = message; // Use innerHTML to allow links
            
            // Insert at top of content area
            const content = document.querySelector('.content');
            content.insertBefore(messageDiv, content.firstChild);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }
    </script>
</body>
</html>
