<html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M.I.N.N.E.S.O.T.A. - Minnesota Institute for Not Necessarily Evidence-Supported Observations, Theories, and Anecdotes</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Linux Libertine', 'Georgia', 'Times', serif;
            line-height: 1.6;
            background: #f6f6f6;
        }

        .header {
            background: #a7d8f0;
            border-bottom: 3px solid #a2a9b1;
            padding: 0.5em 0;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }

        .logo {
            font-size: 1.8em;
            font-weight: bold;
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }

        .logo-subtitle {
            font-size: 0.4em;
            font-weight: normal;
            color: #333;
            display: block;
            margin-top: 2px;
            font-style: italic;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            gap: 20px;
            padding: 20px;
        }

        .sidebar {
            width: 250px;
            background: white;
            border: 1px solid #a2a9b1;
            padding: 15px;
            height: fit-content;
            border-radius: 3px;
        }

        .sidebar h3 {
            background: #eaecf0;
            margin: -15px -15px 10px -15px;
            padding: 8px 15px;
            font-size: 0.95em;
            border-bottom: 1px solid #a2a9b1;
        }

        .sidebar ul {
            list-style: none;
        }

        .sidebar li {
            margin: 5px 0;
        }

        .sidebar a {
            color: #0645ad;
            text-decoration: none;
            display: block;
            padding: 2px 5px;
            border-radius: 2px;
            cursor: pointer;
        }

        .sidebar a:hover {
            background: #f8f9fa;
        }

        .sidebar a.active {
            background: #0645ad;
            color: white;
        }

        .article-list-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 3px;
            margin-bottom: 15px;
        }

        .article-list-container::-webkit-scrollbar {
            width: 8px;
        }

        .article-list-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .article-list-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .article-list-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        #article-list {
            padding: 5px;
        }

        .admin-link {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e0e0e0;
        }

        .admin-link a {
            font-size: 0.85em;
            color: #666;
            font-style: italic;
        }
        
        .last-updated {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #e0e0e0;
            font-size: 0.8em;
            color: #666;
        }

        .content {
            flex: 1;
            background: white;
            border: 1px solid #a2a9b1;
            padding: 20px;
            border-radius: 3px;
        }

        .article-title {
            font-size: 2.2em;
            font-weight: normal;
            margin-bottom: 10px;
            border-bottom: 3px solid #a2a9b1;
            padding-bottom: 5px;
            position: relative;
        }

        .permalink {
            position: absolute;
            right: 0;
            bottom: 8px;
            font-size: 0.4em;
            color: #666;
            text-decoration: none;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .permalink:hover {
            opacity: 1;
            color: #0645ad;
        }

        .article-content h2 {
            font-size: 1.5em;
            margin: 20px 0 10px 0;
            border-bottom: 1px solid #a2a9b1;
            padding-bottom: 2px;
        }

        .article-content h3 {
            font-size: 1.2em;
            margin: 15px 0 8px 0;
        }

        .article-content p {
            margin-bottom: 15px;
            text-align: justify;
        }

        .infobox {
            float: right;
            width: 300px;
            margin: 0 0 15px 15px;
            border: 1px solid #a2a9b1;
            background: #f8f9fa;
            font-size: 0.9em;
        }

        .infobox-title {
            background: #ccccff;
            padding: 5px 10px;
            font-weight: bold;
            text-align: center;
        }

        .infobox-content {
            padding: 10px;
        }

        .infobox-row {
            display: flex;
            margin: 5px 0;
        }

        .infobox-label {
            font-weight: bold;
            width: 100px;
            flex-shrink: 0;
        }

        .search-container {
            margin: 20px 0;
        }

        .search-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #a2a9b1;
            border-radius: 2px;
            font-size: 14px;
        }

        .btn {
            background: #0645ad;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn:hover {
            background: #0b0080;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #54595d;
        }

        .btn-secondary:hover {
            background: #495057;
        }

        .edit-form {
            display: none;
        }

        .edit-form textarea {
            width: 100%;
            height: 400px;
            padding: 10px;
            border: 1px solid #a2a9b1;
            border-radius: 3px;
            font-family: monospace;
            font-size: 14px;
        }

        .form-group {
            margin: 15px 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #a2a9b1;
            border-radius: 2px;
        }

        .admin-controls {
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border: 1px solid #a2a9b1;
            border-radius: 3px;
            position: relative;
        }

        .admin-controls .version-info {
            position: absolute;
            top: 5px;
            right: 10px;
            font-size: 11px;
            color: #666;
            background: #fff;
            padding: 2px 6px;
            border-radius: 2px;
            border: 1px solid #ddd;
        }

        .save-status {
            margin: 10px 0;
            padding: 8px;
            border-radius: 3px;
            font-size: 12px;
            text-align: center;
        }

        .save-status.saving {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .save-status.saved {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .save-status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .big-save-btn {
            font-size: 16px !important;
            padding: 12px 24px !important;
            margin: 10px 5px !important;
            min-width: 120px;
            position: relative;
        }

        .admin-spacing {
            margin-top: 30px;
        }

        .hidden {
            display: none !important;
        }

        .error {
            color: #d33;
            background: #fee;
            padding: 10px;
            border: 1px solid #fcc;
            border-radius: 3px;
            margin: 10px 0;
        }

        .success {
            color: #396;
            background: #efe;
            padding: 10px;
            border: 1px solid #cfc;
            border-radius: 3px;
            margin: 10px 0;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Article ordering styles */
        .article-order-container {
            border: 1px solid #a2a9b1;
            border-radius: 3px;
            background: #f8f9fa;
            margin: 15px 0;
        }

        .article-order-list {
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
        }

        .order-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            margin: 2px 0;
            border: 1px solid #ddd;
            border-radius: 2px;
            background: white;
            cursor: move;
        }

        .order-item:hover {
            background: #f0f8ff;
        }

        .order-item.dragging {
            opacity: 0.5;
        }

        .order-controls {
            display: flex;
            gap: 5px;
        }

        .order-btn {
            font-size: 10px;
            padding: 2px 6px;
            min-width: auto;
        }

        .drag-handle {
            color: #666;
            font-size: 14px;
            margin-right: 8px;
            cursor: move;
        }

        /* Table of Contents styles */
        .toc-container {
            background: #f8f9fa;
            border: 1px solid #a2a9b1;
            border-radius: 3px;
            padding: 15px;
            margin: 20px 0;
        }

        .toc-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #0645ad;
        }

        .toc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .toc-item {
            border: 1px solid #ddd;
            border-radius: 3px;
            padding: 12px;
            background: white;
            transition: box-shadow 0.2s;
        }

        .toc-item:hover {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .toc-item-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .toc-item-title a {
            color: #0645ad;
            text-decoration: none;
        }

        .toc-item-title a:hover {
            text-decoration: underline;
        }

        .toc-item-preview {
            font-size: 0.9em;
            color: #666;
            line-height: 1.4;
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                padding: 10px;
            }
            
            .sidebar {
                width: 100%;
            }
            
            .infobox {
                float: none;
                width: 100%;
                margin: 15px 0;
            }

            .article-list-container {
                max-height: 200px;
            }

            .logo {
                font-size: 1.4em;
            }

            .logo-subtitle {
                font-size: 0.35em;
            }

            .toc-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="#" class="logo" onclick="showHome()">
                M.I.N.N.E.S.O.T.A.
                <span class="logo-subtitle">Minnesota Institute for Not Necessarily Evidence-Supported Observations, Theories, and Anecdotes</span>
            </a>
        </div>
    </header>

    <div class="main-container">
        <aside class="sidebar">
            <h3>Articles</h3>
            <div class="article-list-container">
                <ul id="article-list">
                    <li><a href="#" onclick="showHome()">Main Page</a></li>
                    <li><a href="#table-of-contents" onclick="showTableOfContents()">📚 All Articles</a></li>
                </ul>
            </div>
            
            <h3>Search</h3>
            <div class="search-container">
                <input type="text" class="search-input" placeholder="Search M.I.N.N.E.S.O.T.A..." id="search-input" onkeyup="handleSearch(event)">
                <button onclick="performSearch()" class="btn" style="margin-top: 5px; width: 100%; font-size: 12px; padding: 4px 8px;">Search</button>
            </div>

            <div class="admin-link">
                <a href="#admin" onclick="showArticle('admin')">Login</a>
                <div class="last-updated">
                    <strong>Last Ope-dated:</strong><br>
                    <span id="public-last-updated">Never</span>
                </div>
            </div>

            <div id="admin-sidebar" class="hidden">
                <h3>Admin Tools</h3>
                <ul>
                    <li><a href="#" onclick="showNewArticleForm()">Create New Article</a></li>
                    <li><a href="#" onclick="showEditForm()">Edit Current Article</a></li>
                    <li><a href="#" onclick="showArticleOrdering()">📋 Order Articles</a></li>
                </ul>
            </div>
        </aside>

        <main class="content">
            <div id="article-content" style="display: block;">
                <h1 class="article-title">Welcome to M.I.N.N.E.S.O.T.A.</h1>
                <div class="article-content">
                    <p><strong>M.I.N.N.E.S.O.T.A.</strong> (Minnesota Institute for Not Necessarily Evidence-Supported Observations, Theories, and Anecdotes) is the premier research institution dedicated to documenting Minnesota's most important cultural phenomena, historical events, and legendary figures—regardless of their verifiability.</p>
                    
                    <h2>Our Mission</h2>
                    <p>The Institute is committed to preserving and sharing Minnesota's rich heritage of questionable facts, dubious claims, and thoroughly entertaining stories that may or may not have actually happened. We believe that truth is less important than a good story, especially when that story involves hotdish.</p>
                    
                    <h2>Featured Research</h2>
                    <p>Explore our comprehensive archives documenting crucial Minnesota phenomena, from the legendary <a href="#" onclick="showArticle('giant-paul-bunyan')">Giant Paul Bunyan incident of 1987</a> to the ongoing <a href="#" onclick="showArticle('hotdish-wars')">Great Hotdish Wars</a> that continue to shape the state's culinary and political landscape.</p>
                    
                    <p>Our researchers have meticulously documented unique Minnesota customs like <a href="#" onclick="showArticle('minnesota-goodbye')">The Minnesota Goodbye</a>, a complex social ritual that can extend social gatherings by several hours, and investigated sightings of the elusive <a href="#" onclick="showArticle('lake-monster')">Lake Minnetonka Monster</a>, which demonstrates remarkable camera-avoidance abilities.</p>
                    
                    <p>📚 Browse our complete collection of research documents in the <a href="#" onclick="showTableOfContents()">Table of Contents</a>.</p>
                    
                    <h2>About Our Research Methods</h2>
                    <p>The Institute employs rigorous* research methodologies to ensure the authenticity** of all documented phenomena. Our findings have been thoroughly peer-reviewed*** by leading experts**** in the field of Minnesota studies.</p>
                    
                    <h2>Institute Standards</h2>
                    <p style="font-size: 0.9em; color: #666; background: #f9f9f9; padding: 15px; border-left: 4px solid #a7d8f0;">
                        <strong>Research Quality Assurance:</strong><br>
                        *Rigorous: We ask at least two people if they've heard the story<br>
                        **Authenticity verified through the "Minnesota Nice Test": Does it sound like something a Minnesotan would do?<br>
                        ***Peer review conducted at coffee shops, church basements, and ice fishing houses<br>
                        ****Experts: Individuals who have survived more than three Minnesota winters and can pronounce "Wayzata" correctly
                    </p>
                    
                    <h2>Contact the Institute</h2>
                    <p>For research inquiries, story submissions, or hotdish-related disputes, please contact us through the traditional Minnesota method of bringing up your concerns during casual conversation at the grocery store checkout line.</p>
                `
            },
            "giant-paul-bunyan": {
                "title": "The Giant Paul Bunyan Incident of 1987",
                "content": `
                    <div class="infobox">
                        <div class="infobox-title">Paul Bunyan Incident</div>
                        <div class="infobox-content">
                            <div class="infobox-row">
                                <div class="infobox-label">Date:</div>
                                <div>July 4, 1987</div>
                            </div>
                            <div class="infobox-row">
                                <div class="infobox-label">Location:</div>
                                <div>Bemidji, Minnesota</div>
                            </div>
                            <div class="infobox-row">
                                <div class="infobox-label">Casualties:</div>
                                <div>12 lawn chairs, 1 hot dog stand</div>
                            </div>
                            <div class="infobox-row">
                                <div class="infobox-label">Status:</div>
                                <div>Covered up by Big Tourism</div>
                            </div>
                        </div>
                    </div>
                    
                    <p>The <strong>Giant Paul Bunyan Incident of 1987</strong> remains the most controversial event in Minnesota tourism history, despite efforts by the Minnesota Tourism Board to suppress all documentation of the occurrence.</p>
                    
                    <h2>Background</h2>
                    <p>The 18-foot Paul Bunyan statue in Bemidji had been behaving normally for decades, standing stoically next to Babe the Blue Ox and posing for countless tourist photographs. However, witnesses report that on the morning of July 4th, 1987, the statue began exhibiting what can only be described as "aggressive tourist interaction patterns."</p>
                    
                    <h2>The Incident</h2>
                    <p>According to eyewitness testimony collected by M.I.N.N.E.S.O.T.A. researchers, the statue first showed signs of animation at approximately 10:30 AM during the annual Fourth of July picnic. Mrs. Ethel Nordstrom of Bagley reported that Paul's axe began "twitching menacingly" whenever tourists attempted to pose for photos without purchasing souvenirs from the adjacent gift shop.</p>
                    
                    <p>The situation escalated rapidly when the Bunyan statue reportedly stood up, stretched (causing several car alarms to activate from the sonic boom), and began actively herding tourists toward the gift shop while muttering something about "authentic Minnesota experiences" and "supporting local businesses."</p>
                    
                    <h2>See Also</h2>
                    <p>• <a href="#" onclick="showArticle('minnesota-goodbye')">The Minnesota Goodbye</a><br>
                    • <a href="#" onclick="showArticle('lake-monster')">Lake Minnetonka Monster</a></p>
                `
            },
            "minnesota-goodbye": {
                "title": "The Minnesota Goodbye",
                "content": `
                    <p>The <strong>Minnesota Goodbye</strong> is a complex social ritual practiced throughout the state of Minnesota, characterized by its ability to extend any social gathering by a minimum of 45 minutes to several hours beyond the initial departure announcement.</p>
                    
                    <h2>Definition and Characteristics</h2>
                    <p>Unlike the abrupt departures common in other regions, the Minnesota Goodbye follows a strict protocol that ensures no one's feelings are hurt and that all participants have multiple opportunities to share additional anecdotes, weather observations, and casserole recipes.</p>
                    
                    <h2>The Seven Stages</h2>
                    
                    <h3>Stage 1: The Initial Announcement (5-15 minutes)</h3>
                    <p>The departing party announces their intention to leave, usually prefaced with observations about the time, weather, or upcoming obligations.</p>
                    
                    <h3>Stage 2: The Coat Gathering Ceremony (10-20 minutes)</h3>
                    <p>Participants begin the ritual collection of coats, purses, and casserole dishes.</p>
                    
                    <h2>See Also</h2>
                    <p>• <a href="#" onclick="showArticle('hotdish-wars')">The Great Hotdish Wars</a></p>
                `
            },
            "hotdish-wars": {
                "title": "The Great Hotdish Wars",
                "content": `
                    <p>The <strong>Great Hotdish Wars</strong> refer to the ongoing series of culinary conflicts that have shaped Minnesota's social and political landscape since the early 1950s.</p>
                    
                    <h2>Historical Background</h2>
                    <p>The conflict began innocuously in 1953 when Marge Olson of Hibbing claimed at the annual Lutheran church potluck that her tater tot hotdish was "the best in the Range."</p>
                    
                    <h2>See Also</h2>
                    <p>• <a href="#" onclick="showArticle('minnesota-goodbye')">The Minnesota Goodbye</a><br>
                    • <a href="#" onclick="showArticle('lake-monster')">Lake Minnetonka Monster</a></p>
                `
            },
            "lake-monster": {
                "title": "Lake Minnetonka Monster",
                "content": `
                    <div class="infobox">
                        <div class="infobox-title">Lake Minnetonka Monster</div>
                        <div class="infobox-content">
                            <div class="infobox-row">
                                <div class="infobox-label">First Sighting:</div>
                                <div>June 15, 1923</div>
                            </div>
                            <div class="infobox-row">
                                <div class="infobox-label">Status:</div>
                                <div>Politely elusive</div>
                            </div>
                        </div>
                    </div>
                    
                    <p>The <strong>Lake Minnetonka Monster</strong>, affectionately known as "Tonka" by local residents, is Minnesota's most courteous cryptid.</p>
                    
                    <h2>Discovery and Early Sightings</h2>
                    <p>The creature was first spotted on June 15, 1923, by Margaret Lindström while she was hanging laundry near the shoreline.</p>
                    
                    <h2>See Also</h2>
                    <p>• <a href="#" onclick="showArticle('giant-paul-bunyan')">Giant Paul Bunyan Incident</a></p>
                `
            }
        };
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing M.I.N.N.E.S.O.T.A. wiki...');
            
            const adminSidebar = document.getElementById('admin-sidebar');
            if (adminSidebar) {
                adminSidebar.classList.add('hidden');
            }
            
            const existingMessages = document.querySelectorAll('.error, .success');
            existingMessages.forEach(msg => msg.remove());
            
            loadGitHubConfig();
            showHome();
            updateSidebar();
            updatePublicLastUpdated();
            updateVersionDisplay();
            
            console.log('Wiki initialized. Current version:', wikiVersion);
            console.log('Last saved:', lastSaved);
            console.log('Articles count:', Object.keys(articles).length);
        });
        
        // Authentication functions
        async function authenticateWithAPI(password) {
            try {
                console.log('Attempting authentication with API:', `${API_BASE_URL}/auth`);
                
                const response = await fetch(`${API_BASE_URL}/auth`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ password: password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    githubToken = data.githubToken;
                    return true;
                } else {
                    showMessage(`Authentication failed: ${data.message}`, 'error');
                    return false;
                }
            } catch (error) {
                console.error('Authentication error:', error);
                showMessage(`Authentication service error: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function handleAdminLogin() {
            const password = document.getElementById('admin-login-password').value;
            const loginBtn = document.getElementById('login-btn');
            
            if (!password) {
                showMessage('Please enter a password.', 'error');
                return;
            }
            
            loginBtn.disabled = true;
            loginBtn.textContent = 'Authenticating...';
            
            const success = await authenticateWithAPI(password);
            
            if (success) {
                isLoggedIn = true;
                updateAdminContent();
                updateAuthStatus();
                showMessage('Successfully logged in as administrator.', 'success');
            } else {
                showMessage('Invalid password. Access denied.', 'error');
            }
            
            loginBtn.disabled = false;
            loginBtn.textContent = 'Login';
        }
        
        function handleAdminLoginKeypress(event) {
            if (event.key === 'Enter') {
                handleAdminLogin();
            }
        }
        
        function handleAdminLogout() {
            isLoggedIn = false;
            githubToken = null;
            updateAdminContent();
            updateAuthStatus();
            showMessage('Successfully logged out.', 'success');
        }
        
        function updateAuthStatus() {
            const authStatus = document.getElementById('auth-status');
            if (authStatus) {
                authStatus.textContent = isLoggedIn ? 'Authenticated with GitHub token' : 'Not authenticated';
                authStatus.style.color = isLoggedIn ? '#396' : '#d33';
            }
        }
        
        // Navigation functions
        function showHome() {
            showArticle('home');
        }
        
        function showArticle(articleId) {
            hideAllContentSections();
            document.getElementById('article-content').style.display = 'block';
            
            currentArticle = articleId;
            
            if (articles[articleId]) {
                const article = articles[articleId];
                let titleHtml = `<h1 class="article-title">${article.title}`;
                
                if (articleId !== 'home' && articleId !== 'admin') {
                    titleHtml += `<a href="#${articleId}" class="permalink">¶</a>`;
                }
                
                titleHtml += `</h1>`;
                
                document.getElementById('article-content').innerHTML = `
                    ${titleHtml}
                    <div class="article-content">
                        ${article.content}
                    </div>
                `;
                
                updateActiveLink(articleId);
                
                if (articleId === 'admin') {
                    updateAdminContent();
                }
            } else {
                document.getElementById('article-content').innerHTML = `
                    <h1 class="article-title">Article Not Found</h1>
                    <div class="article-content">
                        <p>The requested article could not be found in the M.I.N.N.E.S.O.T.A. archives.</p>
                        <p><a href="#" onclick="showHome()">Return to Main Page</a></p>
                    </div>
                `;
            }
        }
        
        function hideAllContentSections() {
            document.getElementById('article-content').style.display = 'none';
            document.getElementById('edit-content').style.display = 'none';
            document.getElementById('github-content').style.display = 'none';
            document.getElementById('table-of-contents-content').style.display = 'none';
            document.getElementById('article-ordering-content').style.display = 'none';
        }
        
        function showTableOfContents() {
            hideAllContentSections();
            document.getElementById('table-of-contents-content').style.display = 'block';
            currentArticle = 'table-of-contents';
            updateActiveLink('table-of-contents');
            generateTableOfContents();
        }
        
        function generateTableOfContents() {
            const container = document.getElementById('toc-container');
            let tocHtml = '<div class="toc-grid">';
            
            // Get ordered articles (excluding admin)
            const orderedArticles = getOrderedArticles().filter(key => key !== 'admin');
            
            orderedArticles.forEach(key => {
                const article = articles[key];
                if (article) {
                    // Extract first sentence or paragraph for preview
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = article.content;
                    const textContent = tempDiv.textContent || tempDiv.innerText || '';
                    const preview = textContent.substring(0, 150) + (textContent.length > 150 ? '...' : '');
                    
                    tocHtml += `
                        <div class="toc-item">
                            <div class="toc-item-title">
                                <a href="#${key}" onclick="showArticle('${key}')">${article.title}</a>
                            </div>
                            <div class="toc-item-preview">${preview}</div>
                        </div>
                    `;
                }
            });
            
            tocHtml += '</div>';
            container.innerHTML = tocHtml;
        }
        
        function updateActiveLink(articleId) {
            const links = document.querySelectorAll('.sidebar a, .logo');
            links.forEach(link => link.classList.remove('active'));
            
            if (articleId === 'home') {
                const homeLink = document.querySelector('a[onclick="showHome()"]');
                const logoLink = document.querySelector('.logo');
                if (homeLink) homeLink.classList.add('active');
                if (logoLink) logoLink.classList.add('active');
            } else if (articleId === 'admin') {
                const adminLink = document.querySelector('a[onclick="showArticle(\'admin\')"]');
                if (adminLink) adminLink.classList.add('active');
            } else if (articleId === 'table-of-contents') {
                const tocLink = document.querySelector('a[onclick="showTableOfContents()"]');
                if (tocLink) tocLink.classList.add('active');
            } else {
                const articleLink = document.querySelector(`a[onclick="showArticle('${articleId}')"]`);
                if (articleLink) articleLink.classList.add('active');
            }
        }
        
        function getOrderedArticles() {
            // Return articles in the specified order, with any new articles at the end
            const orderedKeys = ['home'];
            
            // Add articles in custom order
            articleOrder.forEach(key => {
                if (articles[key] && key !== 'home' && key !== 'admin') {
                    orderedKeys.push(key);
                }
            });
            
            // Add any articles not in the order list
            Object.keys(articles).forEach(key => {
                if (key !== 'home' && key !== 'admin' && !orderedKeys.includes(key)) {
                    orderedKeys.push(key);
                }
            });
            
            return orderedKeys;
        }
        
        function updateSidebar() {
            const articleList = document.getElementById('article-list');
            articleList.innerHTML = '';
            
            // Add main page link
            const mainItem = document.createElement('li');
            mainItem.innerHTML = '<a href="#" onclick="showHome()">Main Page</a>';
            articleList.appendChild(mainItem);
            
            // Add table of contents link
            const tocItem = document.createElement('li');
            tocItem.innerHTML = '<a href="#table-of-contents" onclick="showTableOfContents()">📚 All Articles</a>';
            articleList.appendChild(tocItem);
            
            // Add other articles in order (exclude home and admin)
            const orderedArticles = getOrderedArticles();
            orderedArticles.forEach(key => {
                if (key !== 'home' && key !== 'admin') {
                    const item = document.createElement('li');
                    item.innerHTML = `<a href="#${key}" onclick="showArticle('${key}')">${articles[key].title}</a>`;
                    articleList.appendChild(item);
                }
            });
        }
        
        function updateAdminContent() {
            const adminSidebar = document.getElementById('admin-sidebar');
            const adminLoginSection = document.getElementById('admin-login-section');
            const adminDashboard = document.getElementById('admin-dashboard');
            
            if (isLoggedIn) {
                if (adminLoginSection) adminLoginSection.classList.add('hidden');
                if (adminDashboard) adminDashboard.classList.remove('hidden');
                if (adminSidebar) adminSidebar.classList.remove('hidden');
                updateAdminArticleList();
                updateLastSavedTime();
                updateVersionDisplay();
            } else {
                if (adminLoginSection) adminLoginSection.classList.remove('hidden');
                if (adminDashboard) adminDashboard.classList.add('hidden');
                if (adminSidebar) adminSidebar.classList.add('hidden');
            }
        }
        
        function updateAdminArticleList() {
            const list = document.getElementById('admin-article-list');
            if (list) {
                list.innerHTML = '';
                Object.keys(articles).forEach(key => {
                    if (key !== 'admin') {
                        const item = document.createElement('li');
                        item.innerHTML = `${articles[key].title} 
                            <button onclick="editArticle('${key}')" class="btn" style="font-size: 10px; padding: 2px 6px; margin-left: 10px;">Edit</button>
                            <button onclick="deleteArticle('${key}')" class="btn" style="font-size: 10px; padding: 2px 6px; margin-left: 5px; background: #dc3545;">Delete</button>`;
                        list.appendChild(item);
                    }
                });
            }
        }
        
        // Article ordering functions
        function showArticleOrdering() {
            if (!isLoggedIn) {
                showMessage('Please log in to access article ordering.', 'error');
                return;
            }
            
            hideAllContentSections();
            document.getElementById('article-ordering-content').style.display = 'block';
            currentArticle = 'article-ordering';
            generateArticleOrderList();
        }
        
        function generateArticleOrderList() {
            const container = document.getElementById('article-order-list');
            let orderHtml = '';
            
            // Only show articles that can be reordered (not home or admin)
            const reorderableArticles = articleOrder.filter(key => articles[key] && key !== 'home' && key !== 'admin');
            
            // Add any articles not in the order list
            Object.keys(articles).forEach(key => {
                if (key !== 'home' && key !== 'admin' && !reorderableArticles.includes(key)) {
                    reorderableArticles.push(key);
                }
            });
            
            reorderableArticles.forEach((key, index) => {
                const article = articles[key];
                if (article) {
                    orderHtml += `
                        <div class="order-item" draggable="true" data-article-key="${key}">
                            <div style="display: flex; align-items: center;">
                                <span class="drag-handle">⋮⋮</span>
                                <span>${article.title}</span>
                            </div>
                            <div class="order-controls">
                                <button class="btn order-btn" onclick="moveArticleUp('${key}')" ${index === 0 ? 'disabled' : ''}>↑</button>
                                <button class="btn order-btn" onclick="moveArticleDown('${key}')" ${index === reorderableArticles.length - 1 ? 'disabled' : ''}>↓</button>
                            </div>
                        </div>
                    `;
                }
            });
            
            container.innerHTML = orderHtml;
            
            // Add drag and drop functionality
            setupDragAndDrop();
        }
        
        function setupDragAndDrop() {
            const container = document.getElementById('article-order-list');
            let draggedElement = null;
            
            container.addEventListener('dragstart', function(e) {
                if (e.target.classList.contains('order-item')) {
                    draggedElement = e.target;
                    e.target.classList.add('dragging');
                }
            });
            
            container.addEventListener('dragend', function(e) {
                if (e.target.classList.contains('order-item')) {
                    e.target.classList.remove('dragging');
                    draggedElement = null;
                }
            });
            
            container.addEventListener('dragover', function(e) {
                e.preventDefault();
                const afterElement = getDragAfterElement(container, e.clientY);
                if (afterElement == null) {
                    container.appendChild(draggedElement);
                } else {
                    container.insertBefore(draggedElement, afterElement);
                }
            });
            
            container.addEventListener('drop', function(e) {
                e.preventDefault();
                updateArticleOrderFromDOM();
            });
        }
        
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.order-item:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        
        function updateArticleOrderFromDOM() {
            const orderItems = document.querySelectorAll('.order-item');
            articleOrder = Array.from(orderItems).map(item => item.dataset.articleKey);
            updateSidebar();
            generateArticleOrderList(); // Refresh to update button states
            showMessage('Article order updated successfully.', 'success');
        }
        
        function moveArticleUp(articleKey) {
            const index = articleOrder.indexOf(articleKey);
            if (index > 0) {
                [articleOrder[index], articleOrder[index - 1]] = [articleOrder[index - 1], articleOrder[index]];
                updateSidebar();
                generateArticleOrderList();
                showMessage('Article moved up.', 'success');
            }
        }
        
        function moveArticleDown(articleKey) {
            const index = articleOrder.indexOf(articleKey);
            if (index < articleOrder.length - 1) {
                [articleOrder[index], articleOrder[index + 1]] = [articleOrder[index + 1], articleOrder[index]];
                updateSidebar();
                generateArticleOrderList();
                showMessage('Article moved down.', 'success');
            }
        }
        
        function resetArticleOrder() {
            if (confirm('Reset article order to default? This will arrange articles alphabetically.')) {
                articleOrder = Object.keys(articles)
                    .filter(key => key !== 'home' && key !== 'admin')
                    .sort();
                updateSidebar();
                generateArticleOrderList();
                showMessage('Article order reset to default.', 'success');
            }
        }
        
        // Article editing functions
        function showNewArticleForm() {
            if (!isLoggedIn) {
                showMessage('Please log in to access editing functions.', 'error');
                return;
            }
            
            hideAllContentSections();
            document.getElementById('edit-content').style.display = 'block';
            
            document.getElementById('edit-title').value = '';
            document.getElementById('edit-slug').value = '';
            document.getElementById('edit-content-area').value = '';
        }
        
        function showEditForm() {
            if (!isLoggedIn) {
                showMessage('Please log in to access editing functions.', 'error');
                return;
            }
            
            if (currentArticle === 'admin') {
                showMessage('The admin panel cannot be edited.', 'error');
                return;
            }
            
            const article = articles[currentArticle];
            if (!article) {
                showMessage('No article selected for editing.', 'error');
                return;
            }
            
            hideAllContentSections();
            document.getElementById('edit-content').style.display = 'block';
            
            document.getElementById('edit-title').value = article.title;
            document.getElementById('edit-slug').value = currentArticle;
            document.getElementById('edit-content-area').value = article.content.trim();
        }
        
        function editArticle(articleId) {
            currentArticle = articleId;
            showEditForm();
        }
        
        function deleteArticle(articleId) {
            if (!confirm(`Are you sure you want to delete "${articles[articleId].title}"?`)) {
                return;
            }
            
            delete articles[articleId];
            
            // Remove from article order if present
            articleOrder = articleOrder.filter(key => key !== articleId);
            
            updateSidebar();
            updateAdminArticleList();
            showMessage('Article deleted successfully.', 'success');
            
            if (currentArticle === articleId) {
                showHome();
            }
        }
        
        function saveArticle(event) {
            event.preventDefault();
            
            const title = document.getElementById('edit-title').value;
            const slug = document.getElementById('edit-slug').value;
            const content = document.getElementById('edit-content-area').value;
            
            if (!title || !slug || !content) {
                showMessage('Please fill in all fields.', 'error');
                return;
            }
            
            const isNewArticle = !articles[slug];
            
            articles[slug] = {
                title: title,
                content: content
            };
            
            // If it's a new article, add it to the order
            if (isNewArticle && slug !== 'home' && slug !== 'admin') {
                articleOrder.push(slug);
            }
            
            updateSidebar();
            updateAdminArticleList();
            showArticle(slug);
            showMessage('Article saved successfully.', 'success');
        }
        
        async function saveArticleAndBackup() {
            const title = document.getElementById('edit-title').value;
            const slug = document.getElementById('edit-slug').value;
            const content = document.getElementById('edit-content-area').value;
            
            if (!title || !slug || !content) {
                showMessage('Please fill in all fields.', 'error');
                return;
            }
            
            const isNewArticle = !articles[slug];
            
            articles[slug] = {
                title: title,
                content: content
            };
            
            if (isNewArticle && slug !== 'home' && slug !== 'admin') {
                articleOrder.push(slug);
            }
            
            updateSidebar();
            updateAdminArticleList();
            showArticle(slug);
            showMessage('Article saved locally. Backing up to GitHub...', 'success');
            
            await saveWikiToGitHub();
        }
        
        function cancelEdit() {
            hideAllContentSections();
            document.getElementById('article-content').style.display = 'block';
        }
        
        function deleteCurrentArticle() {
            if (currentArticle === 'admin' || currentArticle === 'home') {
                showMessage('This article cannot be deleted.', 'error');
                return;
            }
            
            deleteArticle(currentArticle);
            showHome();
        }
        
        // Search functions
        function handleSearch(event) {
            if (event.key === 'Enter') {
                performSearch();
            }
        }
        
        function performSearch() {
            const query = document.getElementById('search-input').value.toLowerCase();
            if (!query) return;
            
            let results = [];
            Object.keys(articles).forEach(key => {
                if (key === 'admin') return;
                const article = articles[key];
                if (article.title.toLowerCase().includes(query) || 
                    article.content.toLowerCase().includes(query)) {
                    results.push({key, title: article.title});
                }
            });
            
            if (results.length === 0) {
                showMessage('No articles found matching your search.', 'error');
            } else if (results.length === 1) {
                showArticle(results[0].key);
            } else {
                let resultHtml = '<h1 class="article-title">Search Results</h1><div class="article-content"><ul>';
                results.forEach(result => {
                    resultHtml += `<li><a href="#" onclick="showArticle('${result.key}')">${result.title}</a></li>`;
                });
                resultHtml += '</ul></div>';
                
                hideAllContentSections();
                document.getElementById('article-content').innerHTML = resultHtml;
                document.getElementById('article-content').style.display = 'block';
            }
        }
        
        // GitHub configuration functions
        function showGitHubConfig() {
            if (!isLoggedIn) {
                showMessage('Please log in to access GitHub settings.', 'error');
                return;
            }
            
            hideAllContentSections();
            document.getElementById('github-content').style.display = 'block';
            
            document.getElementById('gh-owner').value = githubConfig.owner || '';
            document.getElementById('gh-repo').value = githubConfig.repo || '';
            document.getElementById('gh-branch').value = githubConfig.branch || 'main';
            document.getElementById('gh-path').value = githubConfig.path || 'index.html';
            
            updateAuthStatus();
        }
        
        function saveGitHubConfig() {
            githubConfig = {
                owner: document.getElementById('gh-owner').value,
                repo: document.getElementById('gh-repo').value,
                branch: document.getElementById('gh-branch').value,
                path: document.getElementById('gh-path').value
            };
            
            showMessage('GitHub configuration saved successfully.', 'success');
        }
        
        function loadGitHubConfig() {
            // Config is already set in the initialization
        }
        
        async function testGitHubConnection() {
            if (!githubToken) {
                showMessage('Please log in first to get GitHub authentication.', 'error');
                return;
            }
            
            if (!githubConfig.owner || !githubConfig.repo) {
                showMessage('Please fill in repository owner and name.', 'error');
                return;
            }
            
            try {
                const response = await fetch(`https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}`, {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    showMessage('GitHub connection successful!', 'success');
                } else {
                    showMessage(`GitHub connection failed: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                showMessage(`GitHub connection error: ${error.message}`, 'error');
            }
        }
        
        function incrementVersion() {
            const versionParts = wikiVersion.split('.');
            const newPatchVersion = parseInt(versionParts[2]) + 1;
            versionParts[2] = newPatchVersion.toString();
            wikiVersion = versionParts.join('.');
            console.log('Version incremented to:', wikiVersion);
            updateVersionDisplay();
        }
        
        async function saveWikiToGitHub() {
            if (!githubToken) {
                showMessage('Please log in first to get GitHub authentication.', 'error');
                return;
            }
            
            if (!githubConfig.owner || !githubConfig.repo) {
                showMessage('Please configure GitHub settings first.', 'error');
                return;
            }
            
            if (saveInProgress) {
                showMessage('Save already in progress. Please wait...', 'error');
                return;
            }
            
            const originalVersion = wikiVersion;
            
            try {
                saveInProgress = true;
                updateSaveStatus('saving', '💾 Saving to GitHub...');
                
                incrementVersion();
                
                let sha = null;
                try {
                    const getResponse = await fetch(`https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${githubConfig.path}`, {
                        headers: {
                            'Authorization': `token ${githubToken}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (getResponse.ok) {
                        const data = await getResponse.json();
                        sha = data.sha;
                    }
                } catch (e) {
                    console.log('File does not exist yet, will create new file');
                }
                
                const completeHtml = generateCompleteHtml();
                const content = btoa(unescape(encodeURIComponent(completeHtml)));
                
                const updateData = {
                    message: `Update M.I.N.N.E.S.O.T.A. wiki v${wikiVersion} - ${new Date().toLocaleString()}`,
                    content: content,
                    branch: githubConfig.branch
                };
                
                if (sha) {
                    updateData.sha = sha;
                }
                
                const response = await fetch(`https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${githubConfig.path}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    lastSaved = new Date();
                    updateLastSavedTime();
                    updatePublicLastUpdated();
                    updateSaveStatus('saved', `✅ Saved v${wikiVersion} to GitHub!`);
                    setTimeout(() => hideSaveStatus(), 3000);
                    console.log('Successfully saved to GitHub:', result);
                } else {
                    const errorData = await response.json();
                    console.error('GitHub save failed:', errorData);
                    updateSaveStatus('error', `❌ Failed to save: ${errorData.message}`);
                    wikiVersion = originalVersion;
                    updateVersionDisplay();
                }
            } catch (error) {
                console.error('Save error:', error);
                updateSaveStatus('error', `❌ Error: ${error.message}`);
                wikiVersion = originalVersion;
                updateVersionDisplay();
            } finally {
                saveInProgress = false;
            }
        }
        
        function updateSaveStatus(type, message) {
            const statusEl = document.getElementById('save-status');
            if (statusEl) {
                statusEl.className = `save-status ${type}`;
                statusEl.textContent = message;
                statusEl.classList.remove('hidden');
            }
        }
        
        function hideSaveStatus() {
            const statusEl = document.getElementById('save-status');
            if (statusEl) {
                statusEl.classList.add('hidden');
            }
        }
        
        function updateLastSavedTime() {
            const timeEl = document.getElementById('last-saved-time');
            if (timeEl) {
                if (lastSaved) {
                    timeEl.textContent = lastSaved.toLocaleString();
                } else {
                    timeEl.textContent = 'Never';
                }
            }
        }
        
        function updatePublicLastUpdated() {
            const publicTimeEl = document.getElementById('public-last-updated');
            if (publicTimeEl) {
                if (lastSaved) {
                    publicTimeEl.textContent = lastSaved.toLocaleString();
                } else {
                    publicTimeEl.textContent = 'Never';
                }
            }
        }
        
        function updateVersionDisplay() {
            const versionInfoElements = document.querySelectorAll('.version-info');
            versionInfoElements.forEach(el => {
                el.textContent = `v${wikiVersion}`;
            });
            
            const versionDisplay = document.getElementById('version-info-display');
            if (versionDisplay) {
                versionDisplay.textContent = `v${wikiVersion}`;
            }
            
            const currentVersionDisplay = document.getElementById('current-version-display');
            if (currentVersionDisplay) {
                currentVersionDisplay.textContent = wikiVersion;
            }
        }
        
        async function showVersionHistory() {
            if (!githubToken) {
                showMessage('Please log in first to access version history.', 'error');
                return;
            }
            
            if (!githubConfig.owner || !githubConfig.repo) {
                showMessage('Please configure GitHub settings first.', 'error');
                return;
            }
            
            try {
                const response = await fetch(`https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/commits?path=${githubConfig.path}&per_page=10`, {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const commits = await response.json();
                    displayVersionHistory(commits);
                } else {
                    showMessage(`Failed to fetch version history: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                showMessage(`Error fetching version history: ${error.message}`, 'error');
            }
        }
        
        function displayVersionHistory(commits) {
            let historyHtml = '<h1 class="article-title">Version History</h1><div class="article-content">';
            
            if (commits.length === 0) {
                historyHtml += '<p>No version history found. The wiki hasn\'t been saved to GitHub yet.</p>';
            } else {
                historyHtml += '<div style="max-height: 400px; overflow-y: auto; border: 1px solid #a2a9b1; padding: 15px; background: #f8f9fa;">';
                
                commits.forEach((commit, index) => {
                    const date = new Date(commit.commit.author.date);
                    const timeAgo = getTimeAgo(date);
                    
                    const versionMatch = commit.commit.message.match(/v(\d+\.\d+\.\d+)/);
                    const version = versionMatch ? versionMatch[1] : `1.0.${commits.length - index}`;
                    
                    historyHtml += `
                        <div style="border-bottom: 1px solid #ddd; padding: 10px 0; ${index === commits.length - 1 ? 'border-bottom: none;' : ''}">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <strong style="color: #0645ad;">Version ${version}</strong>
                                <span style="font-size: 12px; color: #666;">${timeAgo}</span>
                            </div>
                            <div style="font-size: 14px; margin-bottom: 5px;">${commit.commit.message}</div>
                            <div style="font-size: 12px; color: #666;">
                                by ${commit.commit.author.name} • 
                                <a href="${commit.html_url}" target="_blank" style="color: #0645ad;">View on GitHub</a>
                            </div>
                        </div>
                    `;
                });
                
                historyHtml += '</div>';
            }
            
            historyHtml += '<div style="margin-top: 15px;"><button onclick="showArticle(\'admin\')" class="btn">Back to Admin Panel</button></div></div>';
            
            hideAllContentSections();
            document.getElementById('article-content').innerHTML = historyHtml;
            document.getElementById('article-content').style.display = 'block';
        }
        
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'just now';
            if (diffMins < 60) return `${diffMins} minute${diffMins === 1 ? '' : 's'} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours === 1 ? '' : 's'} ago`;
            if (diffDays < 30) return `${diffDays} day${diffDays === 1 ? '' : 's'} ago`;
            
            return date.toLocaleDateString();
        }
        
        async function loadWikiFromGitHub() {
            if (!githubToken) {
                showMessage('Please log in first to get GitHub authentication.', 'error');
                return;
            }
            
            if (!githubConfig.owner || !githubConfig.repo) {
                showMessage('Please configure GitHub settings first.', 'error');
                return;
            }
            
            try {
                const response = await fetch(`https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${githubConfig.path}`, {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const content = decodeURIComponent(escape(atob(data.content)));
                    
                    showMessage('Wiki loaded from GitHub! Note: You may need to refresh to see all changes.', 'success');
                } else {
                    showMessage(`Failed to load from GitHub: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                showMessage(`Error loading from GitHub: ${error.message}`, 'error');
            }
        }
        
        function generateCompleteHtml() {
            console.log('Starting HTML generation...');
            
            let html = document.documentElement.outerHTML;
            
            if (lastSaved) {
                html = html.replace(
                    /let lastSaved = null;/,
                    `let lastSaved = new Date('${lastSaved.toISOString()}');`
                );
            }
            
            html = html.replace(
                /let wikiVersion = '[^']+';/,
                `let wikiVersion = '${wikiVersion}';`
            );
            
            // Update article order
            const articleOrderJson = JSON.stringify(articleOrder);
            html = html.replace(
                /let articleOrder = \[[^\]]*\];/,
                `let articleOrder = ${articleOrderJson};`
            );
            
            const articlesJson = JSON.stringify(articles, null, 12)
                .replace(/</g, '\\u003c')
                .replace(/>/g, '\\u003e')
                .replace(/\u2028/g, '\\u2028')
                .replace(/\u2029/g, '\\u2029');
            
            const articlesPattern = /let articles = \{[\s\S]*?\};(?=\s*\/\/ Initialize)/;
            const replacement = `let articles = ${articlesJson};`;
            
            if (articlesPattern.test(html)) {
                html = html.replace(articlesPattern, replacement);
                console.log('✅ Successfully updated articles in HTML');
            } else {
                console.error('❌ Failed to update articles in HTML');
            }
            
            return html;
        }
        
        function showMessage(message, type) {
            const existingMessages = document.querySelectorAll('.error, .success');
            existingMessages.forEach(msg => msg.remove());
            
            const messageDiv = document.createElement('div');
            messageDiv.className = type;
            messageDiv.textContent = message;
            
            const content = document.querySelector('.content');
            if (content) {
                content.insertBefore(messageDiv, content.firstChild);
                
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.remove();
                    }
                }, 5000);
            }
        }
    </script>
</body></html>>
                    
                    <p>📚 Browse our complete collection of research documents in the <a href="#" onclick="showTableOfContents()">Table of Contents</a>.</p>
                    
                    <h2>About Our Research Methods</h2>
                    <p>The Institute employs rigorous* research methodologies to ensure the authenticity** of all documented phenomena. Our findings have been thoroughly peer-reviewed*** by leading experts**** in the field of Minnesota studies.</p>
                    
                    <h2>Institute Standards</h2>
                    <p style="font-size: 0.9em; color: #666; background: #f9f9f9; padding: 15px; border-left: 4px solid #a7d8f0;">
                        <strong>Research Quality Assurance:</strong><br>
                        *Rigorous: We ask at least two people if they've heard the story<br>
                        **Authenticity verified through the "Minnesota Nice Test": Does it sound like something a Minnesotan would do?<br>
                        ***Peer review conducted at coffee shops, church basements, and ice fishing houses<br>
                        ****Experts: Individuals who have survived more than three Minnesota winters and can pronounce "Wayzata" correctly
                    </p>
                    
                    <h2>Contact the Institute</h2>
                    <p>For research inquiries, story submissions, or hotdish-related disputes, please contact us through the traditional Minnesota method of bringing up your concerns during casual conversation at the grocery store checkout line.</p>
                </div>
            </div>

            <div id="edit-content" class="edit-form" style="display: none;">
                <h1 class="article-title">Edit Article</h1>
                <form onsubmit="saveArticle(event)">
                    <div class="form-group">
                        <label for="edit-title">Article Title:</label>
                        <input type="text" id="edit-title" required="">
                    </div>
                    <div class="form-group">
                        <label for="edit-slug">URL Slug:</label>
                        <input type="text" id="edit-slug" required="" placeholder="lowercase-with-hyphens">
                    </div>
                    <div class="form-group">
                        <label for="edit-content-area">Content (HTML allowed):</label>
                        <textarea id="edit-content-area" required="" placeholder="Enter your article content here..."></textarea>
                    </div>
                    <div class="admin-controls">
                        <button type="submit" class="btn">Save Article</button>
                        <button type="button" onclick="saveArticleAndBackup()" class="btn big-save-btn" style="background: #28a745;">💾 Save & Backup to GitHub</button>
                        <button type="button" class="btn btn-secondary" onclick="cancelEdit()">Cancel</button>
                        <button type="button" class="btn btn-secondary" onclick="deleteCurrentArticle()" style="background: #dc3545;">Delete Article</button>
                    </div>
                </form>
            </div>
            
            <div id="github-content" class="edit-form" style="display: none;">
                <h1 class="article-title">GitHub Configuration</h1>
                <div class="article-content">
                    <p><strong>Authentication Status:</strong> <span id="auth-status" style="color: #d33;">Not authenticated</span></p>
                    <p>GitHub token will be retrieved automatically upon successful authentication.</p>
                </div>
                <div class="form-group">
                    <label for="gh-owner">Repository Owner:</label>
                    <input type="text" id="gh-owner" placeholder="GitHub username or organization">
                </div>
                <div class="form-group">
                    <label for="gh-repo">Repository Name:</label>
                    <input type="text" id="gh-repo" placeholder="Repository name">
                </div>
                <div class="form-group">
                    <label for="gh-branch">Branch:</label>
                    <input type="text" id="gh-branch" placeholder="Branch name (e.g., main)" value="main">
                </div>
                <div class="form-group">
                    <label for="gh-path">File Path:</label>
                    <input type="text" id="gh-path" placeholder="Path to HTML file (e.g., index.html)" value="index.html">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        This entire wiki will be saved as a single HTML file
                    </small>
                </div>
                <div class="admin-controls">
                    <button onclick="saveGitHubConfig()" class="btn">Save Configuration</button>
                    <button onclick="testGitHubConnection()" class="btn btn-secondary">Test Connection</button>
                    <button onclick="saveWikiToGitHub()" class="btn">Save Wiki to GitHub</button>
                    <button onclick="loadWikiFromGitHub()" class="btn btn-secondary">Load from GitHub</button>
                    <button type="button" class="btn btn-secondary" onclick="showArticle('admin')">Back to Admin</button>
                </div>
            </div>

            <!-- Table of Contents -->
            <div id="table-of-contents-content" class="edit-form" style="display: none;">
                <h1 class="article-title">📚 Complete Article Collection</h1>
                <div class="article-content">
                    <p>Browse all research documents in the M.I.N.N.E.S.O.T.A. archives. Articles are presented in their current sidebar order.</p>
                    <div id="toc-container" class="toc-container">
                        <!-- Table of contents will be generated here -->
                    </div>
                </div>
            </div>

            <!-- Article Ordering Interface -->
            <div id="article-ordering-content" class="edit-form" style="display: none;">
                <h1 class="article-title">📋 Article Order Management</h1>
                <div class="article-content">
                    <p>Drag and drop articles to reorder how they appear in the sidebar, or use the arrow buttons. Changes are saved automatically.</p>
                    
                    <div class="article-order-container">
                        <div class="admin-controls" style="margin: 0; border: none; background: #eaecf0; border-radius: 0;">
                            <strong>Current Article Order</strong>
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                Main Page and Table of Contents are always first. Only regular articles can be reordered.
                            </div>
                        </div>
                        <div id="article-order-list" class="article-order-list">
                            <!-- Order list will be generated here -->
                        </div>
                    </div>

                    <div class="admin-controls">
                        <button onclick="resetArticleOrder()" class="btn btn-secondary">Reset to Default Order</button>
                        <button onclick="saveWikiToGitHub()" class="btn" style="background: #28a745;">💾 Save Order to GitHub</button>
                        <button onclick="showArticle('admin')" class="btn btn-secondary">Back to Admin</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = '/api';
        
        // State management
        let isLoggedIn = false;
        let currentArticle = 'home';
        let githubToken = null;
        let lastSaved = null;
        let saveInProgress = false;
        let wikiVersion = '1.0.3';
        
        // Article order - controls sidebar display order
        let articleOrder = ['giant-paul-bunyan', 'minnesota-goodbye', 'hotdish-wars', 'lake-monster'];
        
        // GitHub configuration
        let githubConfig = {
            owner: 'BenSweaterVest',
            repo: 'MinnesotaFacts',
            branch: 'main',
            path: 'index.html'
        };
        
        // Sample articles data
        let articles = {
            "admin": {
                "title": "Admin Panel",
                "content": `
                    <div id="admin-login-section" class="admin-spacing">
                        <p>This is the administrative control panel for M.I.N.N.E.S.O.T.A. Please log in to access editing functions.</p>
                        
                        <div class="form-group">
                            <label for="admin-login-password">Admin Password:</label>
                            <input type="password" id="admin-login-password" placeholder="Enter admin password" onkeyup="handleAdminLoginKeypress(event)">
                        </div>
                        <div class="admin-controls">
                            <button onclick="handleAdminLogin()" class="btn" id="login-btn">Login</button>
                        </div>
                    </div>
                    
                    <div id="admin-dashboard" class="hidden">
                        <div id="save-status" class="save-status hidden"></div>
                        
                        <p><strong>Welcome, Administrator!</strong> You now have access to all Institute editing functions.</p>
                        
                        <h2>Quick Actions</h2>
                        <div class="admin-controls">
                            <div class="version-info" id="version-info-display">v1.0.3</div>
                            <button onclick="showNewArticleForm()" class="btn">Create New Article</button>
                            <button onclick="showEditForm()" class="btn btn-secondary">Edit Current Article</button>
                            <button onclick="showArticleOrdering()" class="btn btn-secondary">📋 Order Articles</button>
                            <button onclick="showGitHubConfig()" class="btn btn-secondary">GitHub Settings</button>
                            <button onclick="saveWikiToGitHub()" class="btn big-save-btn" id="big-save-btn" style="background: #28a745;">💾 Save All to GitHub</button>
                            <button onclick="handleAdminLogout()" class="btn" style="background: #dc3545;">Logout</button>
                        </div>
                        
                        <h2>Article Management</h2>
                        <div id="article-management">
                            <p>Current research documents in the Institute archives:</p>
                            <ul id="admin-article-list"></ul>
                            <p style="font-size: 12px; color: #666; margin-top: 10px;">
                                Last saved: <span id="last-saved-time">Never</span>
                            </p>
                        </div>
                        
                        <h2>Version History</h2>
                        <div id="version-history" class="admin-controls">
                            <p style="font-size: 12px; color: #666;">Current version: <strong id="current-version-display">1.0.3</strong></p>
                            <p style="font-size: 11px; color: #888;">Auto-incremented on each save to GitHub</p>
                            <button onclick="showVersionHistory()" class="btn btn-secondary" style="font-size: 11px; padding: 4px 8px;">View History</button>
                        </div>
                    </div>
                `
            },
            "home": {
                "title": "Welcome to M.I.N.N.E.S.O.T.A.",
                "content": `
                    <p><strong>M.I.N.N.E.S.O.T.A.</strong> (Minnesota Institute for Not Necessarily Evidence-Supported Observations, Theories, and Anecdotes) is the premier research institution dedicated to documenting Minnesota's most important cultural phenomena, historical events, and legendary figures—regardless of their verifiability.</p>
                    
                    <h2>Our Mission</h2>
                    <p>The Institute is committed to preserving and sharing Minnesota's rich heritage of questionable facts, dubious claims, and thoroughly entertaining stories that may or may not have actually happened. We believe that truth is less important than a good story, especially when that story involves hotdish.</p>
                    
                    <h2>Featured Research</h2>
                    <p>Explore our comprehensive archives documenting crucial Minnesota phenomena, from the legendary <a href="#" onclick="showArticle('giant-paul-bunyan')">Giant Paul Bunyan incident of 1987</a> to the ongoing <a href="#" onclick="showArticle('hotdish-wars')">Great Hotdish Wars</a> that continue to shape the state's culinary and political landscape.</p>
                    
                    <p>Our researchers have meticulously documented unique Minnesota customs like <a href="#" onclick="showArticle('minnesota-goodbye')">The Minnesota Goodbye</a>, a complex social ritual that can extend social gatherings by several hours, and investigated sightings of the elusive <a href="#" onclick="showArticle('lake-monster')">Lake Minnetonka Monster</a>, which demonstrates remarkable camera-avoidance abilities.</p
